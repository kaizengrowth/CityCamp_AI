name: Deploy CityCamp AI

on:
  push:
    branches: [ main, feature/AI-engineering ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/deploy.yml'
      - 'docker-compose*.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ Starting deployment of CityCamp AI..."
          cd /home/ec2-user

          # Clone or update repository (no terraform needed)
          if [ -d "citycamp-ai" ]; then
            echo "ğŸ“¥ Updating existing repository..."
            cd citycamp-ai
            git fetch origin
            git reset --hard origin/${{ github.ref_name }}
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone git@github.com:kaizengrowth/CityCamp_AI.git citycamp-ai
            cd citycamp-ai
            git checkout ${{ github.ref_name }}
          fi

          # Set up production secrets (no infrastructure changes)
          echo "ğŸ” Setting up application secrets..."
          mkdir -p secrets
          echo '${{ secrets.DATABASE_URL }}' > secrets/database_url
          echo '${{ secrets.SECRET_KEY }}' > secrets/secret_key
          echo '${{ secrets.OPENAI_API_KEY }}' > secrets/openai_api_key
          echo '${{ secrets.GEOCODIO_API_KEY }}' > secrets/geocodio_api_key

          # Stop existing containers
          echo "ğŸ›‘ Stopping existing containers..."
          docker stop citycamp-backend citycamp-frontend || true
          docker rm citycamp-backend citycamp-frontend || true

          # Build and run backend (application deployment only)
          echo "ğŸ”¨ Building backend application..."
          docker build -t citycamp-ai-backend ./backend/

          echo "ğŸš€ Starting backend service..."
          docker run -d --name citycamp-backend -p 8000:8000 \
            -v $(pwd)/secrets:/app/secrets \
            --restart unless-stopped \
            citycamp-ai-backend

          # Health check (no infrastructure validation needed)
          echo "ğŸ” Running health check..."
          sleep 30
          curl -f http://localhost:8000/health || {
            echo "âŒ Health check failed, checking logs..."
            docker logs citycamp-backend
            exit 1
          }

          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Application is running at http://localhost:8000"
